<template>
  <div class="p-5 mt-5">
    <div class="sm-container">
      <!-- User Profile Section -->
      <div class="card">
        <div class="card__img"><svg xmlns="http://www.w3.org/2000/svg" width="100%">
            <rect fill="#ffffff" width="540" height="450"></rect>
            <defs>
              <linearGradient id="a" gradientUnits="userSpaceOnUse" x1="0" x2="0" y1="0" y2="100%"
                gradientTransform="rotate(222,648,379)">
                <stop offset="0" stop-color="#ffffff"></stop>
                <stop offset="1" stop-color="#FC726E"></stop>
              </linearGradient>
              <pattern patternUnits="userSpaceOnUse" id="b" width="300" height="250" x="0" y="0" viewBox="0 0 1080 900">
                <g fill-opacity="0.5">
                  <polygon fill="#444" points="90 150 0 300 180 300"></polygon>
                  <polygon points="90 150 180 0 0 0"></polygon>
                  <polygon fill="#AAA" points="270 150 360 0 180 0"></polygon>
                  <polygon fill="#DDD" points="450 150 360 300 540 300"></polygon>
                  <polygon fill="#999" points="450 150 540 0 360 0"></polygon>
                  <polygon points="630 150 540 300 720 300"></polygon>
                  <polygon fill="#DDD" points="630 150 720 0 540 0"></polygon>
                  <polygon fill="#444" points="810 150 720 300 900 300"></polygon>
                  <polygon fill="#FFF" points="810 150 900 0 720 0"></polygon>
                  <polygon fill="#DDD" points="990 150 900 300 1080 300"></polygon>
                  <polygon fill="#444" points="990 150 1080 0 900 0"></polygon>
                  <polygon fill="#DDD" points="90 450 0 600 180 600"></polygon>
                  <polygon points="90 450 180 300 0 300"></polygon>
                  <polygon fill="#666" points="270 450 180 600 360 600"></polygon>
                  <polygon fill="#AAA" points="270 450 360 300 180 300"></polygon>
                  <polygon fill="#DDD" points="450 450 360 600 540 600"></polygon>
                  <polygon fill="#999" points="450 450 540 300 360 300"></polygon>
                  <polygon fill="#999" points="630 450 540 600 720 600"></polygon>
                  <polygon fill="#FFF" points="630 450 720 300 540 300"></polygon>
                  <polygon points="810 450 720 600 900 600"></polygon>
                  <polygon fill="#DDD" points="810 450 900 300 720 300"></polygon>
                  <polygon fill="#AAA" points="990 450 900 600 1080 600"></polygon>
                  <polygon fill="#444" points="990 450 1080 300 900 300"></polygon>
                  <polygon fill="#222" points="90 750 0 900 180 900"></polygon>
                  <polygon points="270 750 180 900 360 900"></polygon>
                  <polygon fill="#DDD" points="270 750 360 600 180 600"></polygon>
                  <polygon points="450 750 540 600 360 600"></polygon>
                  <polygon points="630 750 540 900 720 900"></polygon>
                  <polygon fill="#444" points="630 750 720 600 540 600"></polygon>
                  <polygon fill="#AAA" points="810 750 720 900 900 900"></polygon>
                  <polygon fill="#666" points="810 750 900 600 720 600"></polygon>
                  <polygon fill="#999" points="990 750 900 900 1080 900"></polygon>
                  <polygon fill="#999" points="180 0 90 150 270 150"></polygon>
                  <polygon fill="#444" points="360 0 270 150 450 150"></polygon>
                  <polygon fill="#FFF" points="540 0 450 150 630 150"></polygon>
                  <polygon points="900 0 810 150 990 150"></polygon>
                  <polygon fill="#222" points="0 300 -90 450 90 450"></polygon>
                  <polygon fill="#FFF" points="0 300 90 150 -90 150"></polygon>
                  <polygon fill="#FFF" points="180 300 90 450 270 450"></polygon>
                  <polygon fill="#666" points="180 300 270 150 90 150"></polygon>
                  <polygon fill="#222" points="360 300 270 450 450 450"></polygon>
                  <polygon fill="#FFF" points="360 300 450 150 270 150"></polygon>
                  <polygon fill="#444" points="540 300 450 450 630 450"></polygon>
                  <polygon fill="#222" points="540 300 630 150 450 150"></polygon>
                  <polygon fill="#AAA" points="720 300 630 450 810 450"></polygon>
                  <polygon fill="#666" points="720 300 810 150 630 150"></polygon>
                  <polygon fill="#FFF" points="900 300 810 450 990 450"></polygon>
                  <polygon fill="#999" points="900 300 990 150 810 150"></polygon>
                  <polygon points="0 600 -90 750 90 750"></polygon>
                  <polygon fill="#666" points="0 600 90 450 -90 450"></polygon>
                  <polygon fill="#AAA" points="180 600 90 750 270 750"></polygon>
                  <polygon fill="#444" points="180 600 270 450 90 450"></polygon>
                  <polygon fill="#444" points="360 600 270 750 450 750"></polygon>
                  <polygon fill="#999" points="360 600 450 450 270 450"></polygon>
                  <polygon fill="#666" points="540 600 630 450 450 450"></polygon>
                  <polygon fill="#222" points="720 600 630 750 810 750"></polygon>
                  <polygon fill="#FFF" points="900 600 810 750 990 750"></polygon>
                  <polygon fill="#222" points="900 600 990 450 810 450"></polygon>
                  <polygon fill="#DDD" points="0 900 90 750 -90 750"></polygon>
                  <polygon fill="#444" points="180 900 270 750 90 750"></polygon>
                  <polygon fill="#FFF" points="360 900 450 750 270 750"></polygon>
                  <polygon fill="#AAA" points="540 900 630 750 450 750"></polygon>
                  <polygon fill="#FFF" points="720 900 810 750 630 750"></polygon>
                  <polygon fill="#222" points="900 900 990 750 810 750"></polygon>
                  <polygon fill="#222" points="1080 300 990 450 1170 450"></polygon>
                  <polygon fill="#FFF" points="1080 300 1170 150 990 150"></polygon>
                  <polygon points="1080 600 990 750 1170 750"></polygon>
                  <polygon fill="#666" points="1080 600 1170 450 990 450"></polygon>
                  <polygon fill="#DDD" points="1080 900 1170 750 990 750"></polygon>
                </g>
              </pattern>
            </defs>
            <rect x="0" y="0" fill="url(#a)" width="100%" height="100%"></rect>
            <rect x="0" y="0" fill="url(#b)" width="100%" height="100%"></rect>
          </svg></div>
        <div class="card__avatar"><img src="/src/assets/img/avtUserDefault.webp"></div>
      </div>
      <div class="mx-md-auto mb-5 mt-5 d-flex flex-column align-items-center">
        <div style="" class="d-flex ">
          <div>
            <p class="profile-header-title"><strong>Họ tên: </strong></p>
            <p class="mt-2"><strong>Email:</strong></p>
            <p class="mt-2"><strong>Ngày tạo: </strong></p>
            <p class="mt-2"><strong>Tổng số đề đã làm:</strong></p>
          </div>
          <div class="ms-3">
            <p>{{ this.userName }}</p>
            <p class="mt-2">{{ userDetail.email }} <button @click="openModalChangeEmail()" type="button"
                data-bs-toggle="modal" data-bs-target="#exampleModal"><i class="fa-solid fa-pen-to-square"></i></button>
            </p>
            <p class="mt-2">{{ userDetail.create_at }} </p>
            <p class="mt-2">{{ listExam.length }}</p>
          </div>
          <div class="modal fade" id="exampleModal" tabindex="-1" @hide="resetEmail()">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Email</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <label for="password" class="form-label">Mật khẩu</label>
                  <input type="password" id="password" class="form-control border border-secondary"
                    placeholder="Nhập mật khẩu của bạn" v-model=" password ">
                  <label for="emailChangeInput" class="form-label mt-3">Email</label>
                  <input type="text" @input="validateEmail()" id="emailChangeInput"
                    class="form-control border border-secondary" v-model=" email ">
                  <p class="text-danger" v-if=" ErrorEmail !== '' ">{{ ErrorEmail }}</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" @click="updateEmailFetch()">Cập nhật</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <!-- End User Profile Section -->
      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a class="nav-link active" style="font-weight: 700">Kết quả luyện thi</a>
        </li>
      </ul>
      <div v-if=" listExam.length > 0 ">
        <div v-for="(       exam, index) in listExam" :key=" index ">
          <div class="user-test">
            <h3 style="font-weight: 600; font-size: 1.5vh; font-size: 1.5vw" id="new-economy-toeic-test-10">
              {{ exam.title }}
            </h3>
            <div class="table-wrapper">
              <table class="table table-sm table-striped text-center">
                <thead>
                  <tr>
                    <th style="min-width: 150px">Ngày làm</th>
                    <th style="min-width: 100px">Kết quả</th>
                    <th style="min-width: 150px">Thời gian làm bài </th>
                    <th style="min-width: 150px"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      {{ exam.created_at }}
                    </td>
                    <td v-if=" exam.score > 0 ">
                      {{ ( exam.score ).toFixed( 1 ) }}
                    </td>
                    <td v-else>{{ exam.score }}</td>
                    <td>{{ exam.formattedTime }}</td>
                    <td>
                      <RouterLink :to=" { name: 'detailResultExam', params: { id: exam.id } } ">
                        Xem chi tiết
                      </RouterLink>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br />
          <hr />
        </div>
      </div>
      <div v-else>
        <p>Bạn chưa làm bài thi nào !</p>
      </div>
      <div class="mb-4 mt-3">
        <ul class="pagination justify-content-center">
          <li style="cursor: pointer" class="page-item" :class=" { active: page == currentPage } "
            v-for="(       page, index) in ListPages" :key=" index ">
            <a class="page-link" @click="changePage( page )">{{ page }}</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</template>
<script>
import { decodeTokenStudent } from '@/service/decodeToken'
import { getUserListResult, getUserListResultByPage } from '@/service/resultServeice'
import { getUserDetail, updateEmailUser } from '@/service/usersService';
import { ElNotification } from 'element-plus'

export default {
  data () {
    return {
      userName: '',
      userId: '',
      listExam: [],
      recordTotal: '',
      totalPage: '',
      currentPage: 1,
      ListPages: [],
      // formattedTime: ''
      userDetail: [],
      email: '',
      ErrorEmail: '',
      EmailValid: null,
      password: '',
    }
  },
  created () {
    this.getListResult()
  },
  methods: {
    async updateEmailFetch () {
      if (this.ErrorEmail === '' && this.email !== this.userDetail.email && this.password !== '')
      {
        const result = await updateEmailUser(this.userId, {
          email: this.email,
          password: this.password
        })
        if (result)
        {
          const message = result.message

          if (message === 'Cập nhật thành công !')
          {
            ElNotification({
              title: 'Thông báo',
              message: "Cập nhật thành công",
              type: 'success'
            })
            this.userDetail.email = this.email
          }
          else if (message === 'Mật khẩu không chính xác !')
          {
            ElNotification({
              title: 'Thông báo',
              message: message,
              type: 'error'
            })
          }
          else
          {
            ElNotification({
              title: 'Thông báo',
              message: message,
              type: 'error'
            })
          }
        }
        else
        {
          ElNotification({
            title: 'Thông báo',
            message: "Có lỗi xảy ra !",
            type: 'error'
          })
        }
      }
      else if (this.email === this.userDetail.email && this.password !== '')
      {
        alert("Bạn hiện tại đang dùng email này cho tài khoản rồi !")
      }
      else if (this.password === '')
      {
        alert("Vui lòng nhập mật khẩu !")
      }
      else
      {
        alert("Vui lòng kiểm tra lại Email")
      }
    },
    openModalChangeEmail () {
      this.password = ''
      this.email = this.userDetail.email
      this.validateEmail()
    },
    // nếu người dùng nhập xong nhưng mà tắt modal đi thì khôi phục lại email trong modal về email gốc
    resetEmail () {
      this.password = ''
      this.email = this.userDetail.email
      this.validateEmail()
    },
    validateEmail () {
      const regex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)$/
      if (this.email === '')
      {
        this.ErrorEmail = 'Vui lòng nhập Email';
        this.EmailValid = false
      } else if (!regex.test(this.email))
      {
        this.ErrorEmail = 'Email không hợp lệ'
        this.EmailValid = false
      } else
      {
        this.ErrorEmail = '';
        this.EmailValid = true
      }
    },
    async getListResult () {
      const user = decodeTokenStudent()
      this.userName = user.data.name
      this.userId = user.data.id
      const userDetail = await getUserDetail(this.userId)
      if (userDetail)
      {
        this.userDetail = userDetail.data
        this.email = this.userDetail.email
      }
      const result = await getUserListResult(user.data.id)
      if (result)
      {
        this.listExam = result.data
        this.recordTotal = result.record_total
        this.totalPage = result.total_page
        // console.log(result)
        // liệt kê các trang của data
        for (var i = 1; i <= this.totalPage; i++)
        {
          this.ListPages.push(i)
        }
        // console.log(this.ListPages)
        // thêm element định dạng time vào mảng listExam
        this.listExam.forEach((event) => {
          var minutes = Math.floor(event.duration / 60) // Tính số phút
          var seconds = event.duration % 60 // Tính số giây còn lại
          var a = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}` // Định dạng thành mm:ss
          event.formattedTime = a;
        })
        // console.log(this.listExam)
      }
    },
    async getResultByPage (page) {
      try
      {
        this.userId = decodeTokenStudent().data.id
        const result = await getUserListResultByPage(this.userId, page)
        if (!result)
        {
          alert('Có lỗi trong quá trình lấy dữ liệu')
        }
        this.listExam = result.data
        this.listExam.forEach((event) => {
          var minutes = Math.floor(event.duration / 60) // Tính số phút
          var seconds = event.duration % 60 // Tính số giây còn lại
          var a = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}` // Định dạng thành mm:ss
          event.formattedTime = a;
        })
      } catch (Error)
      {
        alert(Error)
      }
    },
    async changePage (page) {
      this.currentPage = page
      console.log(this.currentPage)
      await this.getResultByPage(page)
    }
  }
}
</script>
<style scoped>
.active {
  background-color: deepskyblue;
  color: white;
}
.card {
  --main-color: #000;
  --submain-color: #78858F;
  --bg-color: #fff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  border-radius: 20px;
  background: var(--bg-color);
}

.card__img {
  height: 192px;
  width: 100%;
}

.card__img svg {
  height: 100%;
  border-radius: 20px 20px 0 0;
}

.card__avatar {
  position: absolute;
  width: 200px;
  height: 200px;
  background: var(--bg-color);
  border-radius: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  top: calc(50% - 57px);
}

.card__avatar svg {
  width: 150px;
  height: 150px;
}

.card__title {
  margin-top: 60px;
  font-weight: 500;
  font-size: 18px;
  color: var(--main-color);
}

.card__subtitle {
  margin-top: 10px;
  font-weight: 400;
  font-size: 15px;
  color: var(--submain-color);
}

.card__btn {
  margin-top: 15px;
  width: 76px;
  height: 31px;
  border: 2px solid var(--main-color);
  border-radius: 4px;
  font-weight: 700;
  font-size: 11px;
  color: var(--main-color);
  background: var(--bg-color);
  text-transform: uppercase;
  transition: all 0.3s;
}

.card__btn-solid {
  background: var(--main-color);
  color: var(--bg-color);
}

.card__btn:hover {
  background: var(--main-color);
  color: var(--bg-color);
}

.card__btn-solid:hover {
  background: var(--bg-color);
  color: var(--main-color);
}
</style>
